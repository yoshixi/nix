# ============================= Basic behavior =============================

# Mouse + history
setw -g mouse on
set -g history-limit 20000

# Locale
setenv -g LANG "en_US.UTF-8"

# Shell - use reattach-to-user-namespace for Keychain/pasteboard access
set-option -g default-command "reattach-to-user-namespace -l $SHELL"

# Faster escape
set-option -s escape-time 0

# ============================= TPM bootstrap =============================

# Install TPM if missing
if-shell '[ ! -d ~/.tmux/plugins/tpm ]' \
  'run-shell "git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm"'

# Plugins
# // Need to run `prefix` + I to install plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'arcticicestudio/nord-tmux'

# Optionally auto-install plugins once (first launch)
if-shell '[ -d ~/.tmux/plugins/tpm ] && [ ! -d ~/.tmux/plugins/nord-tmux ]' \
  'run-shell "~/.tmux/plugins/tpm/bin/install_plugins"'

# ============================= Keys & prefix =============================

# Unbind default C-b; use C-t as prefix
unbind-key C-b
set -g prefix C-t
bind C-t send-prefix

# For nested tmux sessions
bind-key a send-prefix

# Window split
bind-key v split-window -h
bind-key w split-window -v

# Cycle windows
bind-key -r C-h select-window -t :-
bind-key -r C-l select-window -t :+

# Pane navigation (vim-style)
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Pane resize (vim-style)
bind-key -r H resize-pane -L 2
bind-key -r J resize-pane -D 2
bind-key -r K resize-pane -U 2
bind-key -r L resize-pane -R 2

# Break / kill
bind-key b break-pane
bind-key q kill-pane
bind-key C-q kill-session
bind-key C-x run "tmux kill-pane || tmux kill-window"
bind-key C-t run "tmux last-pane || tmux last-window || tmux new-window"

# Display pane numbers
bind-key i display-panes

# Reload this config (point to the path you use)
bind-key r source-file /etc/nix-darwin/.tmux.conf \; display "Reloaded!"

# Quick helpers
bind-key m command-prompt -p "Man:" "split-window 'man %%'"
bind-key g command-prompt -p "Google Translate en->ja:" "split-window 'source ~/.zshrc >/dev/null; gte %% | less'"
bind-key G command-prompt -p "Google Translate ja->en:" "split-window 'source ~/.zshrc >/dev/null; gtj %% | less'"

# ============================= Indices & titles =============================

# Start window/pane numbering at 1
set-option -g base-index 1
setw -g pane-base-index 1

# Stable window names and nice WM titles
set-option -g allow-rename off
set-option -g set-titles on
set-option -g set-titles-string "[tmux] #T @ #H"

# Message display time (ms)
set-option -g display-time 3500

# ============================= Appearance =============================

# Terminal type (use tmux-256color if available; else fall back)
set -g default-terminal "tmux-256color"

# Status bar colors (Solarized-esque)
set-option -g status-bg colour235
set-option -g status-fg colour136
set-window-option -g clock-mode-colour colour64
set-option -g display-panes-active-colour colour33
set-option -g display-panes-colour colour166

# ============================= Copy mode =============================

# Use vi keys in copy mode
set-window-option -g mode-keys vi
bind-key [ copy-mode \; display "Copy mode!"

# Native macOS clipboard (reattach-to-user-namespace enables Keychain access)
set -g set-clipboard on
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode C-u send-keys -X page-up
bind-key -T copy-mode C-d send-keys -X page-down

# ============================= Initialize TPM (keep last) =============================
run '~/.tmux/plugins/tpm/tpm'
